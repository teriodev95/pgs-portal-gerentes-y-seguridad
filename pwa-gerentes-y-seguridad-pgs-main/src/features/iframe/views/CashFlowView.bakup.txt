<script setup lang="ts">
import { onBeforeMount, ref } from 'vue';
import { ROUTE_NAME } from '@/router';
import { toCurrency } from '@/shared/utils';
import type { ICashFlow } from '@/interfaces';
import { useStore } from '@/shared/stores';

// Components
import ArrowDown from '@/shared/components/icons/ArrowDown.vue';
import ArrowUp from '@/shared/components/icons/ArrowUp.vue';
import CardContainer from '@/shared/components/CardContainer.vue';
import NavbarTop from '@/shared/components/NavbarTop.vue'
import SectionContainer from '@/shared/components/SectionContainer.vue';

// Services and stores
const $store = useStore();

// State
const cashFlowData = ref<ICashFlow>();
const isLoading = ref(false);

// Methods
async function fetchCashFlowData() {
  try {
    isLoading.value = true;
  } catch (error) {
    console.error('Error fetching cash flow data:', error);
  } finally {
    isLoading.value = false;
  }
}

// Lifecycle hooks
onBeforeMount(async () => {
  await fetchCashFlowData();
});
</script>

<template>
  <main class="h-screen bg-slate-100">
    <div class="block p-2 dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700">
      <div class="sticky top-0 z-20 w-full bg-white p-2">
        <NavbarTop label="Flujo de Efectivo" :back="{ name: ROUTE_NAME.DASHBOARD_HOME }" />
      </div>
    </div>

    <iframe
      :src="`https://v0-ui-flujo-efectivo.vercel.app/?gerencia=${$store.gerenciaSelected}&semana=${$store.currentDate.week}&anio=${$store.currentDate.year}`"
      class="w-full min-h-screen" frameborder="0">
    </iframe>

    <template class="hidden">
      <SectionContainer v-if="cashFlowData">
        <!-- SUMMARY SECTION -->
        <CardContainer>
          <h2 class="title">Resumen</h2>

          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Egresos</p>
            <p class="badget badget-danger">
              <ArrowUp class="size-4" />
              {{ toCurrency(cashFlowData.egresos.total) }}
            </p>
          </div>
          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Ingresos</p>
            <p class="badget badget-success">
              <ArrowDown class="size-4" />
              {{ toCurrency(cashFlowData.ingresos.total) }}
            </p>
          </div>
          <hr class="line" />
          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Diferencia</p>
            <p class="font-md-700 text-blue-800">
              {{ toCurrency(cashFlowData.saldo) }}
            </p>
          </div>
        </CardContainer>

        <!-- ASSIGNMENTS SECTION -->
        <CardContainer>
          <h2 class="title">Asignaciones</h2>

          <div class="space-y-2">
            <div v-for="(income, index) in cashFlowData.ingresos.asignaciones.detalles" :key="income.fecha + index"
              class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">{{ income.concepto }}</p>
              <p class="font-md-700 text-blue-800">
                {{ toCurrency(income.monto) }}
              </p>
            </div>

            <hr class="line" />

            <div class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">Total</p>
              <p class="badget badget-success">
                <ArrowDown class="size-4" />
                {{ toCurrency(cashFlowData.ingresos.asignaciones.total) }}
              </p>
            </div>
          </div>

          <div class="space-y-2">
            <div v-for="(expense, index) in cashFlowData.egresos.asignaciones.detalles" :key="expense.fecha + index"
              class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">{{ expense.concepto }}</p>
              <p class="font-md-700 text-blue-800">
                {{ toCurrency(expense.monto) }}
              </p>
            </div>

            <hr class="line" />

            <div class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">Total</p>
              <p class="badget badget-danger">
                <ArrowUp class="size-4" />
                {{ toCurrency(cashFlowData.egresos.asignaciones.total) }}
              </p>
            </div>
          </div>
        </CardContainer>

        <!-- INCIDENTS SECTION -->
        <CardContainer>
          <h2 class="title">Incidentes</h2>

          <div class="space-y-2">
            <div v-for="(income, index) in cashFlowData.ingresos.incidentes.detalles" :key="income.fecha + index"
              class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">Recibo de {{ income.concepto }}</p>
              <p class="font-md-700 text-blue-800">
                {{ toCurrency(income.monto) }}
              </p>
            </div>

            <hr class="line" />

            <div class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">Total</p>
              <p class="badget badget-success">
                <ArrowDown class="size-4" />
                {{ toCurrency(cashFlowData.ingresos.incidentes.total) }}
              </p>
            </div>
          </div>

          <div class="space-y-2">
            <div v-for="(expense, index) in cashFlowData.egresos.incidentes.detalles" :key="expense.fecha + index"
              class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">{{ expense.concepto }}</p>
              <p class="font-md-700 text-blue-800">
                {{ toCurrency(expense.monto) }}
              </p>
            </div>

            <hr class="line" />

            <div class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">Total</p>
              <p class="badget badget-danger">
                <ArrowUp class="size-4" />
                {{ toCurrency(cashFlowData.egresos.incidentes.total) }}
              </p>
            </div>
          </div>
        </CardContainer>

        <!-- FIRST PAYMENTS SECTION -->
        <CardContainer>
          <h2 class="title">Primeros Pagos</h2>

          <div class="space-y-2">
            <div v-for="(income, index) in cashFlowData.ingresos.primerosPagos.detalles" :key="income.fecha + index"
              class="flex justify-between items-center gap-2">
              <p class="font-300 text-gray-400">{{ income.concepto }}</p>
              <p class="font-md-700 text-blue-800">
                {{ toCurrency(income.monto) }}
              </p>
            </div>
          </div>

          <hr class="line" />

          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Cantidad</p>
            <p class="font-md-700 text-blue-800">
              {{ cashFlowData.ingresos.primerosPagos.detalles.length }}
            </p>
          </div>
          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Total</p>
            <p class="badget badget-success">
              <ArrowDown class="size-4" />
              {{ toCurrency(cashFlowData.ingresos.primerosPagos.total) }}
            </p>
          </div>
        </CardContainer>

        <!-- SALES SECTION -->
        <CardContainer>
          <h2 class="title">Ventas</h2>

          <div v-for="(expense, index) in cashFlowData.egresos.ventas.detalles" :key="expense.fecha + index"
            class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">{{ expense.concepto }}</p>
            <p class="font-md-700 text-blue-800">
              {{ toCurrency(expense.monto) }}
            </p>
          </div>

          <hr class="line" />

          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Total</p>
            <p class="badget badget-danger">
              <ArrowUp class="size-4" />
              {{ toCurrency(cashFlowData.egresos.ventas.total) }}
            </p>
          </div>
        </CardContainer>

        <!-- WEEKLY EXPENSES SECTION -->
        <CardContainer>
          <h2 class="title">Gastos Semanales</h2>

          <div v-for="(expense, index) in cashFlowData.egresos.gastos.detalles" :key="expense.fecha + index"
            class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">{{ expense.concepto }}</p>
            <p class="font-md-700 text-blue-800">
              {{ toCurrency(expense.monto) }}
            </p>
          </div>

          <hr class="line" />

          <div class="flex justify-between items-center gap-2">
            <p class="font-300 text-gray-400">Total</p>
            <p class="badget badget-danger">
              <ArrowUp class="size-4" />
              {{ toCurrency(cashFlowData.egresos.gastos.total) }}
            </p>
          </div>
        </CardContainer>
      </SectionContainer>

      <div v-else>
        <p class="text-center text-gray-400">No hay informaci√≥n disponible</p>
      </div>
    </template>
  </main>
</template>